<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>退職代行 進行管理ダッシュボード</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* カスタムスクロールバーなどの微調整 */
    .kanban-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .kanban-scroll::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    .kanban-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .kanban-scroll::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    }

    /* モーダルのアニメーション */
    dialog[open] {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
    }
  </style>
</head>

<body class="bg-gray-50 text-slate-800 min-h-screen">

  <div class="p-6">
    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold flex items-center gap-2 text-slate-800">
          <i data-lucide="file-text" class="w-8 h-8 text-blue-600"></i>
          退職代行 進行管理ダッシュボード
        </h1>
        <p class="text-slate-500 mt-1 ml-10">業務フローステータス可視化システム</p>
      </div>
      <button onclick="openModal('create')"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        新規案件追加
      </button>
    </header>

    <!-- KPI Cards Container -->
    <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <!-- JSで描画 -->
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

      <!-- Left: Charts & Controls -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Phase Distribution Chart -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
          <h3 class="font-semibold mb-4 text-slate-700">フェーズ別分布</h3>
          <div class="h-64 relative">
            <canvas id="phaseChart"></canvas>
          </div>
        </div>

        <!-- Search & Filter -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
          <h3 class="font-semibold mb-4 text-slate-700">検索・フィルタ</h3>
          <div class="space-y-4">
            <div class="relative">
              <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
              <input type="text" id="searchInput" placeholder="名前またはIDで検索"
                class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="text-xs text-slate-500 font-semibold mb-2 block uppercase">表示フェーズ</label>
              <div id="filter-buttons" class="space-y-2">
                <!-- JSでボタン生成 -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Kanban Board -->
      <div class="lg:col-span-3 overflow-x-auto kanban-scroll">
        <div id="kanban-board" class="flex gap-4 min-w-[1000px] h-full pb-4">
          <!-- JSでボード描画 -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Create Modal -->
  <dialog id="userModal" class="p-0 rounded-xl shadow-2xl w-full max-w-lg bg-white backdrop:bg-gray-900/50">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 id="modalTitle" class="text-xl font-bold text-slate-800">案件情報の編集</h3>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-1">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="userForm" onsubmit="handleFormSubmit(event)" class="space-y-4">
        <input type="hidden" id="editUserId">

        <!-- ID & Name -->
        <div class="grid grid-cols-3 gap-4">
          <div class="col-span-1">
            <label class="block text-sm font-medium text-slate-700 mb-1">ID (自動)</label>
            <input type="text" id="inputId"
              class="w-full p-2 bg-slate-100 border border-slate-200 rounded text-slate-500" readonly>
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-1">氏名 <span class="text-red-500">*</span></label>
            <input type="text" id="inputName" required
              class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <!-- Phase & Step -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">フェーズ</label>
            <select id="inputPhase" onchange="updateStepOptions()"
              class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500">
              <!-- JSで生成 -->
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">進捗ステップ</label>
            <select id="inputStep" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500">
              <!-- JSで生成 -->
            </select>
          </div>
        </div>

        <!-- Date & Status -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">更新日</label>
            <input type="date" id="inputDate" required
              class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">状態ステータス</label>
            <select id="inputStatus"
              class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500">
              <option value="normal">通常 (Normal)</option>
              <option value="urgent">要対応 (Urgent)</option>
              <option value="warning">注意 (Warning)</option>
              <option value="critical">トラブル (Critical)</option>
              <option value="stuck">停滞 (Stuck)</option>
              <option value="completed">完了 (Completed)</option>
              <option value="new">新規 (New)</option>
            </select>
          </div>
        </div>

        <!-- Note -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">備考</label>
          <textarea id="inputNote" rows="3"
            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center pt-4 mt-4 border-t border-slate-100">
          <button type="button" id="deleteBtn" onclick="deleteUser()"
            class="text-red-600 hover:text-red-700 font-medium px-4 py-2 rounded hover:bg-red-50 flex items-center gap-2">
            <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
          </button>
          <div class="flex gap-2">
            <button type="button" onclick="closeModal()"
              class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">キャンセル</button>
            <button type="submit"
              class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow-sm">保存する</button>
          </div>
        </div>
      </form>
    </div>
  </dialog>

  <!-- JavaScript Logic -->
  <script>
    // --- データ定義 ---
    const PHASES = {
      A: {
        label: 'Phase A: 入金・検討中',
        desc: 'フォーム回答〜入金確認 <br>(保存: 最終接触から6ヶ月)',
        colorClass: 'border-t-blue-500',
        bgClass: 'bg-blue-50',
        icon: 'dollar-sign',
        steps: ['①フォーム回答', '②ヒアリング', '③最終確認', '④入金待ち']
      },
      B: {
        label: 'Phase B: 会社対応中',
        desc: '代行実施〜退職受理 <br>(保存: 無期限)',
        colorClass: 'border-t-purple-500',
        bgClass: 'bg-purple-50',
        icon: 'briefcase',
        steps: ['⑤代行実施', '⑥交渉・報告']
      },
      C: {
        label: 'Phase C: 書類到着待ち',
        desc: '退職後〜書類受取 <br>(保存: 3ヶ月)',
        colorClass: 'border-t-orange-500',
        bgClass: 'bg-orange-50',
        icon: 'mail',
        steps: ['⑦書類待ち', '⑧受取確認']
      },
      D: {
        label: 'Phase D: 完了・アーカイブ',
        desc: '対応終了 <br>(検索用: 2週間, 証跡: 5年)',
        colorClass: 'border-t-gray-500',
        bgClass: 'bg-gray-50',
        icon: 'check-circle-2',
        steps: ['⑨完了', 'みなし完了']
      }
    };

    const STATUS_COLORS = {
      normal: 'bg-white',
      urgent: 'bg-red-50 border-red-200',
      warning: 'bg-yellow-50 border-yellow-200',
      stuck: 'bg-red-100 border-red-300',
      completed: 'bg-gray-100 opacity-70',
      new: 'bg-green-50 border-green-200',
      critical: 'bg-red-100 text-red-900 border-red-300'
    };

    // --- 初期データ ---
    const generateMockData = () => {
      return [
        { id: 'U001', name: '佐藤 健太', phase: 'A', step: '④入金待ち', date: '2024-04-10', status: 'normal', note: '最終確認シート送付済み' },
        { id: 'U002', name: '鈴木 花子', phase: 'B', step: '⑤代行実施予定', date: '2024-04-12', status: 'urgent', note: '明日9:00実施希望' },
        { id: 'U003', name: '田中 一郎', phase: 'C', step: '⑦書類待ち', date: '2024-03-20', status: 'warning', note: '会社から連絡遅延あり' },
        { id: 'U004', name: '高橋 優子', phase: 'D', step: '⑨完了', date: '2024-04-01', status: 'completed', note: '本人確認画像受領済み' },
        { id: 'U005', name: '渡辺 誠', phase: 'A', step: '①フォーム回答', date: '2024-04-14', status: 'new', note: 'ヒアリングシート未記入' },
        { id: 'U006', name: '伊藤 直人', phase: 'B', step: '⑥結果報告待ち', date: '2024-04-11', status: 'normal', note: '電話代行中' },
        { id: 'U007', name: '山本 さくら', phase: 'C', step: '⑧受取確認', date: '2024-03-05', status: 'stuck', note: '1ヶ月以上書類届かず（紛争可能性）' },
        { id: 'U008', name: '中村 隆', phase: 'A', step: '③最終確認中', date: '2024-04-13', status: 'normal', note: '利用規約確認中' },
        { id: 'U009', name: '小林 あゆみ', phase: 'D', step: 'みなし完了', date: '2024-02-28', status: 'completed', note: '14日間連絡なしのため自動完了' },
        { id: 'U010', name: '加藤 浩', phase: 'B', step: '⑥退職交渉中', date: '2024-04-09', status: 'critical', note: '会社側が難色' },
        { id: 'U011', name: '吉田 麻衣', phase: 'A', step: '②ヒアリング', date: '2024-04-14', status: 'new', note: '' },
        { id: 'U012', name: '松本 潤', phase: 'C', step: '⑦書類待ち', date: '2024-04-05', status: 'normal', note: '離職票待ち' },
      ];
    };

    // --- アプリケーションの状態 ---
    let appData = generateMockData();
    let currentFilter = 'ALL';
    let currentSearch = '';
    let myChart = null;

    // --- CRUD ロジック ---

    // モーダルを開く
    function openModal(mode, userId = null) {
      const modal = document.getElementById('userModal');
      const form = document.getElementById('userForm');
      const title = document.getElementById('modalTitle');
      const deleteBtn = document.getElementById('deleteBtn');
      const phaseSelect = document.getElementById('inputPhase');

      // Phaseのセレクトボックス初期化（初回のみ実行されるようにチェックしても良いが、毎回再生成しても軽い）
      phaseSelect.innerHTML = Object.entries(PHASES).map(([key, val]) =>
        `<option value="${key}">${val.label}</option>`
      ).join('');

      if (mode === 'create') {
        title.textContent = '新規案件追加';
        form.reset();
        document.getElementById('editUserId').value = '';
        document.getElementById('inputId').value = 'U' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'); // 簡易ID生成
        document.getElementById('inputDate').valueAsDate = new Date();
        deleteBtn.classList.add('hidden');

        // ステップの初期化
        updateStepOptions();
      } else {
        title.textContent = '案件情報の編集';
        const user = appData.find(u => u.id === userId);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('inputId').value = user.id;
        document.getElementById('inputName').value = user.name;
        document.getElementById('inputPhase').value = user.phase;
        document.getElementById('inputDate').value = user.date;
        document.getElementById('inputStatus').value = user.status;
        document.getElementById('inputNote').value = user.note || '';

        deleteBtn.classList.remove('hidden');

        // ステップの選択肢を更新してから値をセット
        updateStepOptions();
        document.getElementById('inputStep').value = user.step;
      }

      modal.showModal();
    }

    // モーダルを閉じる
    function closeModal() {
      document.getElementById('userModal').close();
    }

    // フェーズ変更時にステップの選択肢を更新
    function updateStepOptions() {
      const phase = document.getElementById('inputPhase').value;
      const stepSelect = document.getElementById('inputStep');
      const steps = PHASES[phase].steps;

      stepSelect.innerHTML = steps.map(step =>
        `<option value="${step}">${step}</option>`
      ).join('');
    }

    // 保存（新規作成 or 更新）
    function handleFormSubmit(e) {
      e.preventDefault();

      const id = document.getElementById('inputId').value;
      const editUserId = document.getElementById('editUserId').value;
      const isEdit = !!editUserId;

      const newData = {
        id: id,
        name: document.getElementById('inputName').value,
        phase: document.getElementById('inputPhase').value,
        step: document.getElementById('inputStep').value,
        date: document.getElementById('inputDate').value,
        status: document.getElementById('inputStatus').value,
        note: document.getElementById('inputNote').value
      };

      if (isEdit) {
        // 更新
        const index = appData.findIndex(u => u.id === editUserId);
        if (index !== -1) {
          appData[index] = newData;
        }
      } else {
        // 新規
        appData.push(newData);
      }

      closeModal();
      refreshAll();
    }

    // 削除
    function deleteUser() {
      const id = document.getElementById('editUserId').value;
      if (!confirm(`案件ID: ${id} を削除してもよろしいですか？`)) return;

      appData = appData.filter(u => u.id !== id);
      closeModal();
      refreshAll();
    }

    // --- レンダリング関数群 ---

    function refreshAll() {
      const counts = renderKPIs();
      renderChart(counts);
      renderFilterButtons();
      renderKanban();
      lucide.createIcons();
    }

    function renderKPIs() {
      const counts = { A: 0, B: 0, C: 0, D: 0 };
      let urgentCount = 0;
      let stuckCount = 0;

      appData.forEach(user => {
        if (counts[user.phase] !== undefined) counts[user.phase]++;
        if (user.status === 'urgent' || user.status === 'critical') urgentCount++;
        if (user.status === 'stuck') stuckCount++;
      });

      const totalActive = appData.length - counts.D;

      const kpiHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500">進行中案件 (A-C)</p>
                            <h2 class="text-3xl font-bold text-slate-800">${totalActive}</h2>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg">
                            <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500">本日対応要</p>
                            <h2 class="text-3xl font-bold text-red-500">${urgentCount}</h2>
                        </div>
                        <div class="p-2 bg-red-50 rounded-lg">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                        </div>
                    </div>
                    <p class="text-xs text-red-400 mt-2">※即時対応が必要なアクション</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500">長期滞留・紛争</p>
                            <h2 class="text-3xl font-bold text-yellow-600">${stuckCount}</h2>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded-lg">
                            <i data-lucide="clock" class="w-5 h-5 text-yellow-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">書類待ち3ヶ月以上など</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500">今月の完了</p>
                            <h2 class="text-3xl font-bold text-green-600">${counts.D}</h2>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg">
                            <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600"></i>
                        </div>
                    </div>
                </div>
            `;
      document.getElementById('kpi-container').innerHTML = kpiHTML;
      return counts;
    }

    function renderChart(counts) {
      const ctx = document.getElementById('phaseChart').getContext('2d');

      const data = {
        labels: ['入金・検討(A)', '会社対応(B)', '書類待ち(C)', '完了(D)'],
        datasets: [{
          data: [counts.A, counts.B, counts.C, counts.D],
          backgroundColor: ['#60A5FA', '#C084FC', '#FB923C', '#9CA3AF'],
          borderWidth: 0
        }]
      };

      if (myChart) {
        myChart.data = data;
        myChart.update();
      } else {
        myChart = new Chart(ctx, {
          type: 'doughnut',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: { boxWidth: 12, usePointStyle: true }
              }
            }
          }
        });
      }
    }

    function renderFilterButtons() {
      const container = document.getElementById('filter-buttons');
      let html = `
                <button onclick="setFilter('ALL')" 
                    class="w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${currentFilter === 'ALL' ? 'bg-slate-100 font-medium' : 'hover:bg-slate-50'}">
                    すべて表示
                </button>
            `;

      for (const [key, info] of Object.entries(PHASES)) {
        html += `
                    <button onclick="setFilter('${key}')"
                        class="w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors ${currentFilter === key ? 'bg-slate-100 font-medium' : 'hover:bg-slate-50'}">
                        <i data-lucide="${info.icon}" class="w-4 h-4"></i>
                        ${info.label}
                    </button>
                `;
      }
      container.innerHTML = html;
    }

    function renderKanban() {
      const container = document.getElementById('kanban-board');
      let html = '';

      const filteredData = appData.filter(user => {
        const matchesPhase = currentFilter === 'ALL' || user.phase === currentFilter;
        const matchesSearch = user.name.includes(currentSearch) || user.id.includes(currentSearch);
        return matchesPhase && matchesSearch;
      });

      for (const [phaseKey, phaseInfo] of Object.entries(PHASES)) {
        const usersInPhase = filteredData.filter(user => user.phase === phaseKey);

        html += `
                    <div class="flex-1 min-w-[240px] flex flex-col h-full">
                        <div class="p-3 rounded-t-xl border-t border-x border-slate-200 bg-white shadow-sm mb-2 flex flex-col gap-1 border-t-4 ${phaseInfo.colorClass}">
                            <div class="flex justify-between items-center">
                                <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                    <i data-lucide="${phaseInfo.icon}" class="w-4 h-4"></i>
                                    ${phaseInfo.label.split(':')[0]}
                                </h4>
                                <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold">
                                    ${usersInPhase.length}
                                </span>
                            </div>
                            <p class="text-xs text-slate-500 leading-tight">${phaseInfo.desc}</p>
                        </div>

                        <div class="flex-1 bg-slate-100/50 rounded-xl p-2 space-y-3">
                            ${usersInPhase.length === 0 ? `
                                <div class="text-center py-8 text-slate-400 text-sm border-2 border-dashed border-slate-200 rounded-lg">
                                    案件なし
                                </div>
                            ` : usersInPhase.map(user => `
                                <div onclick="openModal('edit', '${user.id}')" class="p-3 rounded-lg shadow-sm border transition-all hover:shadow-md cursor-pointer group ${STATUS_COLORS[user.status] || 'bg-white border-slate-200'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-bold text-slate-800">${user.name}</span>
                                        <span class="text-xs text-slate-400 font-mono">${user.id}</span>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <span class="inline-block px-2 py-0.5 bg-slate-800 text-white text-xs rounded-md">
                                            ${user.step}
                                        </span>
                                    </div>

                                    ${user.note ? `
                                        <div class="text-xs text-slate-600 mb-2 bg-black/5 p-1.5 rounded">
                                            ${user.note}
                                        </div>
                                    ` : ''}

                                    <div class="flex justify-between items-center text-xs text-slate-400 mt-2 border-t border-slate-100/50 pt-2">
                                        <span class="flex items-center gap-1">
                                            <i data-lucide="clock" class="w-3 h-3"></i>
                                            ${user.date}
                                        </span>
                                        <i data-lucide="edit-2" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity text-blue-500"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
      }

      container.innerHTML = html;
    }

    // --- イベントハンドラ ---

    function setFilter(phase) {
      currentFilter = phase;
      refreshAll();
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      currentSearch = e.target.value;
      renderKanban();
      lucide.createIcons();
    });

    // モーダル背景クリックで閉じる
    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target.id === 'userModal') closeModal();
    });

    // --- 初期化 ---
    function init() {
      refreshAll();
    }

    window.addEventListener('DOMContentLoaded', init);

  </script>
</body>

</html>